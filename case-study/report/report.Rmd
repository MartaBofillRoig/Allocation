---
title: "Optimal allocations: Case study / Simulations"
author: "M"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly 
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Preface




# Code

R functions

```{r}
# install.packages("plyr")
library(plyr)
# devtools::install_github("pavlakrotka/NCC@v1.0")
library(NCC)
source("C:/Users/mbofi/Dropbox/CeMSIIS/GitHub/Allocation/case-study/aux_functions.R")
```

# Case Study


We illustrate the optimal allocations in platform trials by means of a  phase  II  placebo-controlled  trial  in primary  hypercholesterolemia. 

```{r, echo=F}
# sample sizes original study
n_control = 31
n_arm1 = 31
n_arm2 = 30
N = n_control + n_arm1 + n_arm2 
```

In the original study, $N=92$ patients were randomised following 1:1:1. The estimated means were 
```{r} 
# means
mean_control = 17.3/3.5
mean_arm1 = 66.2/3.5
mean_arm2 = 72.3/3.5
```


In what follows, we simulated the trial using the estimated means in the original study using three allocation strategies, namely equal allocation (1:...:1), square root of $k$ (1:...:$\sqrt(k)$), and the proposed optimal allocations) and according to three different trial designs:

  (1) Design with one period only (that is, multi-arm design)
  (2) Design with two periods (arm 2 starts later, but arms 1 and 2 finish at the same time)
  (3) Design with three periods (arm 2 starts later and finishes after arm 1 does)


## Design 1: multi-arm design

```{r}
db1_one = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db1_sqrt = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
db1_opt = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
```

Distribution of sample sizes per arm and periods
```{r}
# sample sizes
db1_one$ss
db1_sqrt$ss
db1_opt$ss
```

Comparison of results 

```{r}
(res1_one = do.call(rbind.data.frame, models_cc(data = db1_one$data) ))
(res1_sqrt = do.call(rbind.data.frame, models_cc(data = db1_sqrt$data) ))
(res1_opt = do.call(rbind.data.frame, models_cc(data = db1_opt$data) ))
```


## Design 1: two-period design

```{r} 
db2_one=sim_designs(r1=n_arm1/N,r2=1-n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db2_sqrt=sim_designs(r1=n_arm1/N,r2=1-n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db2_opt=sim_designs(r1=n_arm1/N,r2=1-n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")

plot_trial(db2_opt$data$treatment) 

# sample sizes
db2_one$ss
db2_sqrt$ss
db2_opt$ss

(res2_one = do.call(rbind.data.frame, models_cc(data = db2_one$data) ))
(res2_sqrt = do.call(rbind.data.frame, models_cc(data = db2_sqrt$data) ))
(res2_opt = do.call(rbind.data.frame, models_cc(data = db2_opt$data) ))
```



# Simulations

To compare power and type 1 error of the different designs, we undertake a simulation study to evaluate the performance when using 1:1 allocations, 
