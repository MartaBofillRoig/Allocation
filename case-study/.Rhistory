# using concurrent and non-concurrent controls
lf_a1=fixmodel_cont(data,arm=1,alpha=alpha)
lf_a1[[6]] <- "a1"
names(lf_a1)[[6]] <- "arm"
# lf_a1[[7]] <- "ncc"
# names(lf_a1)[7] <- "model"
lf_a2=fixmodel_cont(data,arm=2,alpha=alpha)
lf_a2[[6]] <- "a2"
names(lf_a2)[[6]] <- "arm"
# lf_a2[[7]] <- "ncc"
# names(lf_a2)[7] <- "model"
return(list(lf_a1,lf_a2))
}
res = do.call(rbind.data.frame, models_cc(data = db$data) )
head(res)
res_ncc = do.call(rbind.data.frame, models_ncc(data = db$data) )
head(res_ncc)
# original study
n_control = 31
n_arm1 = 31
n_arm2 = 30
N = n_control + n_arm1 + n_arm2
# means
mean_control = 17.3/3.5
mean_arm1 = 66.2/3.5
mean_arm2 = 72.3/3.5
# design 1: multi-arm design
db1_one = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db1_sqrt = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
db1_opt = sim_designs(r1=1,r2=0,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
# head(db)
mod <- lm(response ~ as.factor(treatment), db1_sqrt$data)
summary(mod)
# simulations
library(dplyr)
nsim=10000
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm2,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y_t1e)/nsim
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
# simulations
library(dplyr)
nsim=10000
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
# (y_a1 = filter(y, arm == "a1"))
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
# sample sizes
db3_one$ss
db3_sqrt$ss
# design 3: three-period design
db3_one=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3_sqrt=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3_opt=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
plot_trial(db3_opt$data$treatment)
# sample sizes
db3_one$ss
db3_sqrt$ss
db3_opt$ss
sum(db3_one$ss)
sum(db3_opt$ss)
sum(db3_opt$ss)[1,]
sum(db3_opt$ss[1,])
library(dplyr)
nsim=10000
N=50
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
r1=20/70;r2=30/70;mu0=0;mu1=1;mu2=1;N=70;alloc="opt"
N=50
r3 = 1-r1-r2
if(r1 == 1){
if(alloc == "one"){
r22 <- r11 <- r01 <- r1/3
r02 <- r12 <- r23 <- r03 <- 0
}
if(alloc != "one"){
r01 <- sqrt(2)/(2+sqrt(2))
r22 <- r11 <- (1-r01)/2
r02 <- r12 <- r23 <- r03 <- 0
}
}else{
if(alloc == "opt"){
r11 <- r01 <- r1/2
r2_opt <- f(r1=r1,r2=r2)
r02 <- r2_opt[3]
r12 <- r2_opt[4]
r22 <- r2_opt[5]
r23 <- r03 <- r3/2
}
if(alloc == "one"){
r11 <- r01 <- r1/2
r22 <- r12 <- r02 <- r2/3
r23 <- r03 <- r3/2
}
if(alloc == "sqrt"){
r11 <- r01 <- r1/2
r02 <- r2*sqrt(2)/(2+sqrt(2))
r22 <- r12 <- (r2-r02)/2
r23 <- r03 <- r3/2
}
}
n11 = round(r11*N)
n01 = round(r01*N)
n22 = round(r22*N)
n12 = round(r12*N)
n02 = round(r02*N)
n23 = round(r23*N)
n03 = round(r03*N)
means = c(mu0,mu1,mu2)
treatment = c(
sample(c(rep(1,n11),rep(0,n01))),
sample(c(rep(2,n22),rep(1,n12),rep(0,n02))),
sample(c(rep(2,n23),rep(0,n03)))
)
Nsim = length(treatment)
if(r1==1){
treatment = sample(treatment)
period = rep(1,Nsim)
}else{
period = c(
rep(1,n11+n01),
rep(2,n22+n12+n02),
rep(3,n23+n03)
)
}
response = rnorm(Nsim,
mean=means[treatment[1:Nsim]+1]+sw_trend(cj=1:Nsim, lambda=sl),
sd=1)
r1=n_arm1/N
r2=1-2*n_arm1/N
r1
r2
2*n_arm1/N
n_arm1
N
N=50
n_arm1=N/3
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$ss
y1_t1e <- y %>%
# filter(arm == "a1") %>%
select(reject_h0)
sum(filter(y1_t1e, arm == "a1"))/nsim
sum(filter(y1_t1e, y1_t1e$arm == "a1"))/nsim
y1_t1e <- y %>%
# filter(arm == "a1") %>%
select(reject_h0)
sum(filter(y1_t1e, arm == "a1"))/nsim
sum(filter(y1_t1e, y1_t1e$arm == "a1"))/nsim
y1_t1e
y %>%
# filter(arm == "a1") %>%
select(reject_h0)
y1_t1e <- y %>%
# filter(arm == "a1") %>%
select(reject_h0, arm)
y1_t1e
sum(filter(y1_t1e,arm == "a1"))/nsim
filter(y1_t1e,arm == "a1")
library(dplyr)
nsim=10000
N=50
n_arm1=N/3
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
# design 3: three-period design (symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
plot_trial(db3b_opt$data$treatment)
# sample sizes
db3b_one$ss
db3b_sqrt$ss
# original study
n_control = 31
n_arm1 = 31
n_arm2 = 30
N = n_control + n_arm1 + n_arm2
# means
mean_control = 17.3/3.5
mean_arm1 = 66.2/3.5
mean_arm2 = 72.3/3.5
# design 3: three-period design (non-symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
plot_trial(db3b_opt$data$treatment)
n_arm1/N
n_arm1/N
# design 3: three-period design (non-symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
plot_trial(db3b_opt$data$treatment)
# sample sizes
db3b_one$ss
db3b_sqrt$ss
db3b_opt$ss
n_arm1/N/2
n_arm1/N/2+n_arm1/N
r1=n_arm1/N;r2=n_arm1/N/2
r3 = 1-r1-r2
# original study
n_control = 31
n_arm1 = 31
n_arm2 = 30
N = n_control + n_arm1 + n_arm2
r1=n_arm1/N;r2=n_arm1/N/2
# design 3: three-period design (non-symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
# r1=n_arm1/N;r2=n_arm1/N/2
# sample sizes
db3b_one$ss
db3b_sqrt$ss
db3b_opt$ss
r3 = 1-r1-r2
if(r1 == 1){
if(alloc == "one"){
r22 <- r11 <- r01 <- r1/3
r02 <- r12 <- r23 <- r03 <- 0
}
if(alloc != "one"){
r01 <- sqrt(2)/(2+sqrt(2))
r22 <- r11 <- (1-r01)/2
r02 <- r12 <- r23 <- r03 <- 0
}
}else{
if(alloc == "opt"){
r11 <- r01 <- r1/2
r2_opt <- f(r1=r1,r2=r2)
r02 <- r2_opt[3]
r12 <- r2_opt[4]
r22 <- r2_opt[5]
r23 <- r03 <- r3/2
}
if(alloc == "one"){
r11 <- r01 <- r1/2
r22 <- r12 <- r02 <- r2/3
r23 <- r03 <- r3/2
}
if(alloc == "sqrt"){
r11 <- r01 <- r1/2
r02 <- r2*sqrt(2)/(2+sqrt(2))
r22 <- r12 <- (r2-r02)/2
r23 <- r03 <- r3/2
}
}
# c(r11,r01)
n11 = round(r11*N)
n01 = round(r01*N)
n22 = round(r22*N)
n12 = round(r12*N)
n02 = round(r02*N)
n23 = round(r23*N)
n03 = round(r03*N)
matrix(c(0,n11,n01,n22,n12,n02,n23,0,n03), nrow=3)
r11 <- r01 <- r1/2
r02 <- r2*sqrt(2)/(2+sqrt(2))
r22 <- r12 <- (r2-r02)/2
r23 <- r03 <- r3/2
c(r11,r01,r22,r12,r02,r23,r03)
round(r22*N)
round(r12*N)
round(r12*N)
round(r12*N)
round(r12*N)
round(r12*N)
round(r22*N)
n22
round(r22*N)
n22
round(r22*N)
r3 = 1-r1-r2
if(r1 == 1){
if(alloc == "one"){
r22 <- r11 <- r01 <- r1/3
r02 <- r12 <- r23 <- r03 <- 0
}
if(alloc != "one"){
r01 <- sqrt(2)/(2+sqrt(2))
r22 <- r11 <- (1-r01)/2
r02 <- r12 <- r23 <- r03 <- 0
}
}else{
if(alloc == "opt"){
r11 <- r01 <- r1/2
r2_opt <- f(r1=r1,r2=r2)
r02 <- r2_opt[3]
r12 <- r2_opt[4]
r22 <- r2_opt[5]
r23 <- r03 <- r3/2
}
if(alloc == "one"){
r11 <- r01 <- r1/2
r22 <- r12 <- r02 <- r2/3
r23 <- r03 <- r3/2
}
if(alloc == "sqrt"){
r11 <- r01 <- r1/2
r02 <- r2*sqrt(2)/(2+sqrt(2))
r22 <- r12 <- (r2-r02)/2
r23 <- r03 <- r3/2
}
}
alloc == "sqrt"
# design 3: three-period design (non-symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
plot_trial(db3b_opt$data$treatment)
# r1=n_arm1/N;r2=n_arm1/N/2
# sample sizes
db3b_one$ss
db3b_sqrt$ss
db3b_opt$ss
r1=n_arm1/N;r2=n_arm1/N/2
r3 = 1-r1-r2
r1 == 1
r11 <- r01 <- r1/2
r02 <- r2*sqrt(2)/(2+sqrt(2))
r22 <- r12 <- (r2-r02)/2
r23 <- r03 <- r3/2
c(r11,r01,r22,r12,r02,r23,r03)
round(r11*N)
round(r01*N)
round(r22*N)
round(r12*N)
round(r02*N)
round(r23*N)
round(r03*N)
n11 = round(r11*N)
n01 = round(r01*N)
n22 = round(r22*N)
n12 = round(r12*N)
n02 = round(r02*N)
n23 = round(r23*N)
n03 = round(r03*N)
means = c(mu0,mu1,mu2)
c(n11,n01,n22,n12,n02,n23,n03)
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
# design 3: three-period design (symmetric design)
db3_one=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3_sqrt=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
db3_opt=sim_designs(r1=n_arm1/N,r2=1-2*n_arm1/N,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
plot_trial(db3_opt$data$treatment)
# sample sizes
db3_one$ss
db3_sqrt$ss
db3_opt$ss
# design 3: three-period design (non-symmetric design)
db3b_one=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="one")
db3b_sqrt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="sqrt")
db3b_opt=sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,N=N,alloc="opt")
plot_trial(db3b_opt$data$treatment)
# r1=n_arm1/N;r2=n_arm1/N/2;alloc="sqrt"
# sample sizes
db3b_one$ss
db3b_sqrt$ss
db3b_opt$ss
(res3b_one = do.call(rbind.data.frame, models_cc(data = db3b_one$data) ))
(res3b_sqrt = do.call(rbind.data.frame, models_cc(data = db3b_sqrt$data) ))
(res3b_opt = do.call(rbind.data.frame, models_cc(data = db3b_opt$data) ))
N
library(dplyr)
nsim=10000
N=50
n_arm1=N/3
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,
mu0=mean_control,mu1=mean_arm1,mu2=mean_arm2,
N=N,alloc="one")$data
)
)
)
# (y_a1 = filter(y, arm == "a1"))
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0, arm)
sum(y1_t1e)/nsim
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
mean_control
mean_arm1
mean_arm2
library(dplyr)
nsim=10000
N=50
n_arm1=N/3
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,
mu0=mean_control,mu1=5,mu2=10,
N=N,alloc="one")$data
)
)
)
# (y_a1 = filter(y, arm == "a1"))
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
library(dplyr)
nsim=10000
N=50
n_arm1=N/3
y = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,
mu0=mean_control,mu1=6,mu2=8,
N=N,alloc="one")$data
)
)
)
# (y_a1 = filter(y, arm == "a1"))
y1_t1e <- y %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
y_opt = rdply(nsim,
do.call(rbind.data.frame,
models_cc(data = sim_designs(r1=n_arm1/N,r2=n_arm1/N/2,
mu0=mean_control,mu1=6,mu2=7,
N=N,alloc="opt")$data
)
)
)
# t1e / power
y1_t1e <- y_opt %>%
filter(arm == "a1") %>%
select(reject_h0)
sum(y1_t1e)/nsim
y2_t1e <- y_opt %>%
filter(arm == "a2") %>%
select(reject_h0)
sum(y2_t1e)/nsim
setwd("C:/Users/mbofi/Dropbox/CeMSIIS/GitHub/Allocation/case-study")
source("C:/Users/mbofi/Dropbox/CeMSIIS/GitHub/Allocation/case-study/sim_casestudy.R")
